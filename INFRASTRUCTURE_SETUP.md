# Infrastructure Setup Guide

This guide walks you through setting up Azure infrastructure and GitHub Actions for automated deployments.

## üöÄ Quick Start

Follow these steps in order:

### Step 1: Install Required Tools

Run the installation script:

```bash
./setup-infrastructure.sh
```

This installs:
- Azure CLI (`az`)
- GitHub CLI (`gh`)

### Step 2: Authenticate

Login to both services:

```bash
# Login to Azure
az login

# Login to GitHub
gh auth login
```

Follow the prompts in your browser to authenticate.

### Step 3: Configure Azure Infrastructure

Run the Azure configuration script:

```bash
./configure-azure.sh
```

This will:
- Create Azure Resource Group
- Create Service Principal for GitHub Actions
- Configure Azure SQL Database firewall
- Save Azure credentials to `.azure-credentials.json`

**Note**: You'll be prompted for:
- Resource Group name (default: `Devops_Project`)
- Azure region (default: `northeurope`)

### Step 4: Set Up GitHub Secrets

Run the GitHub secrets configuration script:

```bash
./setup-github-secrets.sh
```

This will:
- Automatically set all required GitHub secrets
- Use values from `.azure-credentials.json` and `backend2/.env`

**You'll need**:
- DockerHub username (default: `shoaibzmian`)
- DockerHub access token ([Get it here](https://hub.docker.com/settings/security))
- Azure Resource Group name (from Step 3)
- Azure Location (from Step 3)

### Step 5: Deploy

Push your changes to trigger the deployment:

```bash
git add .
git commit -m "Add GitHub Actions deployment workflow"
git push origin main
```

Or manually trigger the workflow:

```bash
gh workflow run azure-deploy.yml
```

## üìã What Gets Created

### Azure Resources

1. **Resource Group**: Container for all Azure resources
2. **Service Principal**: Identity for GitHub Actions to deploy
3. **Virtual Network**: Network for container communication
4. **Container Instances**:
   - Frontend container (React app)
   - Backend container (ASP.NET Core API)

### GitHub Secrets

All secrets are automatically configured:

| Secret | Source |
|--------|--------|
| `DOCKERHUB_USERNAME` | Manual input |
| `DOCKERHUB_TOKEN` | Manual input |
| `AZURE_CREDENTIALS` | Generated by `configure-azure.sh` |
| `AZURE_SUBSCRIPTION_ID` | From Azure CLI |
| `AZURE_RESOURCE_GROUP` | Manual input |
| `AZURE_LOCATION` | Manual input |
| `DB_CONNECTION_STRING` | From `backend2/.env` |
| `JWT_ISSUER` | Set to localhost (update after deployment) |
| `JWT_AUDIENCE` | Set to localhost (update after deployment) |
| `JWT_SECRET` | From `backend2/.env` |

## üîç Monitoring Deployment

### View Workflow Runs

```bash
# List recent workflow runs
gh run list

# Watch current run
gh run watch

# View specific run
gh run view <run-id>
```

### Check Container Status

```bash
# List containers in resource group
az container list --resource-group <your-rg-name> --output table

# View container logs
az container logs --resource-group <your-rg-name> --name backend2
az container logs --resource-group <your-rg-name> --name frontend

# Check container status
az container show --resource-group <your-rg-name> --name backend2 --query instanceView.state
```

## üåê Access Your Application

After successful deployment, you'll get URLs like:

```
Frontend: http://frontend-<rg-name>.<location>.azurecontainer.io
Backend: http://backend2-<rg-name>.<location>.azurecontainer.io
Swagger: http://backend2-<rg-name>.<location>.azurecontainer.io/swagger
```

## üîß Post-Deployment Configuration

### Update JWT Settings

After first deployment, update JWT issuer and audience with the actual backend URL:

```bash
BACKEND_URL="http://backend2-<your-rg-name>.<location>.azurecontainer.io"

gh secret set JWT_ISSUER --body "$BACKEND_URL" --repo ShoaibZMian/Devops_project
gh secret set JWT_AUDIENCE --body "$BACKEND_URL" --repo ShoaibZMian/Devops_project
```

Then redeploy:

```bash
gh workflow run azure-deploy.yml
```

## üîí Security Notes

### Important Files (DO NOT COMMIT!)

The following files contain sensitive information and are git-ignored:

- `.azure-credentials.json` - Service Principal credentials
- `azure-setup-summary.txt` - Setup summary with credentials
- `backend2/.env` - Database and JWT secrets

### Verify `.gitignore`

Ensure these patterns are in `.gitignore`:

```
.azure-credentials.json
azure-setup-summary.txt
*.env
```

## üêõ Troubleshooting

### Azure Login Issues

```bash
# Clear Azure account cache
az account clear

# Login again
az login
```

### GitHub CLI Authentication Issues

```bash
# Logout and login again
gh auth logout
gh auth login
```

### Deployment Fails

1. **Check workflow logs**:
   ```bash
   gh run list
   gh run view <run-id>
   ```

2. **Verify secrets are set**:
   ```bash
   gh secret list --repo ShoaibZMian/Devops_project
   ```

3. **Check Azure resources**:
   ```bash
   az group show --name <your-rg-name>
   az container list --resource-group <your-rg-name> --output table
   ```

### Container Won't Start

1. **Check container logs**:
   ```bash
   az container logs --resource-group <rg-name> --name backend2 --tail 100
   ```

2. **Verify environment variables**:
   ```bash
   az container show --resource-group <rg-name> --name backend2 --query containers[0].environmentVariables
   ```

3. **Check SQL firewall**:
   - Azure Portal ‚Üí SQL Server ‚Üí Networking ‚Üí Firewall rules
   - Ensure "Allow Azure services" is enabled

### Frontend Can't Connect to Backend

1. Verify backend is running:
   ```bash
   curl http://backend2-<rg-name>.<location>.azurecontainer.io/swagger
   ```

2. Check frontend environment variable:
   ```bash
   az container show --resource-group <rg-name> --name frontend --query containers[0].environmentVariables
   ```

   Should show: `REACT_APP_HOST_IP_ADDRESS=http://backend2-<rg-name>.<location>.azurecontainer.io`

## üîÑ Manual Deployment Commands

### Deploy Specific Component

```bash
# Redeploy backend only
az container delete --resource-group <rg-name> --name backend2 --yes
gh workflow run azure-deploy.yml

# Redeploy frontend only
az container delete --resource-group <rg-name> --name frontend --yes
gh workflow run azure-deploy.yml
```

### Rebuild and Deploy

```bash
# Trigger workflow with rebuild
git commit --allow-empty -m "Trigger rebuild"
git push
```

## üìä Cost Monitoring

View your Azure costs:

```bash
# Show cost analysis
az consumption usage list --start-date 2025-10-01 --end-date 2025-10-31
```

Estimated costs:
- Container Instances: ~$30-60/month (depending on usage)
- Azure SQL: Based on your existing plan
- Networking: Minimal (egress charges only)

## üõë Cleanup

To remove all Azure resources:

```bash
# Delete resource group (removes all resources)
az group delete --name <your-rg-name> --yes --no-wait

# Delete service principal
az ad sp delete --id $(az ad sp list --display-name "github-actions-<rg-name>" --query [0].appId -o tsv)
```

## üìö Additional Resources

- [Azure CLI Documentation](https://docs.microsoft.com/en-us/cli/azure/)
- [GitHub CLI Documentation](https://cli.github.com/manual/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Azure Container Instances Documentation](https://docs.microsoft.com/en-us/azure/container-instances/)
- [.github/DEPLOYMENT_SETUP.md](.github/DEPLOYMENT_SETUP.md) - Detailed deployment workflow documentation
